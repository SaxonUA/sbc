<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WoT Tracker –ö–æ–ª–µ—Å–æ</title>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }
    canvas {
      background: transparent;
      border-radius: 50%;
      box-shadow: 0 0 15px #444;
    }
    .wheel-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .arrow {
      width: 0;
      height: 0;
      border-left: 30px solid transparent;
      border-right: 30px solid transparent;
      border-bottom: 50px solid red;
      position: absolute;
      top: -55px;
      left: 50%;
      transform: translateX(-50%) rotate(180deg);
      z-index: 10;
      box-shadow: 0 0 15px rgba(255,0,0,0.6);
    }
    button {
      margin-top: 20px;
      padding: 10px 25px;
      font-size: 16px;
      background: linear-gradient(145deg, #ff6600, #1a1a1a);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: all 0.2s ease-in-out;
    }
    button:hover {
      background: linear-gradient(145deg, #ff8800, #2a2a2a);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.35);
    }
    .result {
      margin-top: 10px;
      font-size: 22px;
      font-weight: bold;
      color: #ff9900;
    }
    #loading {
      margin-top: 20px;
      font-size: 18px;
      color: #bbbbbb;
    }
    #winners {
      margin-top: 30px;
      font-size: 20px;
      color: #66ff99;
    }
  </style>
</head>
<body>
  <div class="wheel-wrapper">
    <div class="arrow"></div>
    <canvas id="nicknameWheel" width="350" height="350"></canvas>
  </div>

  <div class="result" id="nicknameResult">...</div>
  <button id="spinBtn" onclick="spin()" disabled>–ö—Ä—É—Ç–∏—Ç–∏ –∫–æ–ª–µ—Å–æ</button>
  <div id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω—ñ–∫—ñ–≤ –∑ Google Sheets...</div>

  <div id="winners">
    <p>üéÅ –ü–µ—Ä–µ–º–æ–∂–µ—Ü—å 1: <span id="winner1">‚Äî</span></p>
    <p>üéÅ –ü–µ—Ä–µ–º–æ–∂–µ—Ü—å 2: <span id="winner2">‚Äî</span></p>
  </div>

  <script>
    const SHEET_ID   = "17phnEn-NW-OnrZg4DcW65r-Xoq6ScsdVjS5yL0SS3fk";
    const API_KEY    = "AIzaSyDmE9Bt5HlFccXs_-Z109RVxIyv_itgonM";
    const SHEET_NAME = "TURVIB";
    const COLUMN_C   = "C";

    let nicknames = [];
    let spinning  = false;
    let currentAngle = 0;
    let spinCount = 0;
    let winners = [];

    function drawWheel(canvasId, items, angleOffset = 0, highlightIndex = -1) {
      const canvas   = document.getElementById(canvasId);
      const ctx      = canvas.getContext("2d");
      const radius   = canvas.width / 2;
      const centerX  = radius;
      const centerY  = radius;
      const total    = items.length;
      const angleStep = (2 * Math.PI) / total;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < total; i++) {
        const angle = i * angleStep + angleOffset;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, angle, angle + angleStep);
        ctx.fillStyle = (i === highlightIndex) ? "#ffa600" : (i % 2 === 0 ? "#ff6600" : "#1a1a1a");
        ctx.fill();
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angle + angleStep / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "white";
        ctx.font = "11px sans-serif";
        const label = items[i];
        ctx.fillText(label.length > 30 ? label.slice(0, 27) + "‚Ä¶" : label, radius - 10, 4);
        ctx.restore();
      }
    }

    function spin() {
      if (spinning || nicknames.length === 0) return;
      spinning = true;
      document.getElementById("spinBtn").disabled = true;

      let angle     = currentAngle;
      let velocity  = 1.5 + Math.random() * 0.5; // –í–∏—â–∞ –ø–æ—á–∞—Ç–∫–æ–≤–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å
      const totalDuration = 22000; // 22 —Å–µ–∫—É–Ω–¥–∏
      const startTime = performance.now();
      let lastIndex  = -1;

      function animate(time) {
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / totalDuration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        angle = currentAngle + easeOut * 20 * Math.PI;

        const index = Math.floor(((3 * Math.PI / 2 - (angle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI)) / (2 * Math.PI) * nicknames.length) % nicknames.length;

        if (index !== lastIndex) lastIndex = index;
        drawWheel("nicknameWheel", nicknames, angle, index);

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          currentAngle = angle % (2 * Math.PI);
          const selected = nicknames[index];
          document.getElementById("nicknameResult").textContent = selected;
          if (!winners.includes(selected)) {
            winners.push(selected);
          }
          if (spinCount === 0) {
            document.getElementById("winner1").textContent = selected;
          } else if (spinCount === 1) {
            document.getElementById("winner2").textContent = selected;
          }
          spinCount++;
          spinning = false;
          if (spinCount < 2) {
            document.getElementById("spinBtn").disabled = false;
          }
        }
      }

      requestAnimationFrame(animate);
    }

    async function loadNicknames() {
      const urlC = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_NAME + "!" + COLUMN_C + ":" + COLUMN_C)}?key=${API_KEY}`;
      try {
        const resC = await fetch(urlC);
        if (!resC.ok) throw new Error("Network response was not ok");
        const dataC = await resC.json();

        const rawNames = (dataC.values || []).flat().map(n => n.trim()).filter(Boolean);
        nicknames = [...new Set(rawNames)];

        if (nicknames.length === 0) throw new Error("No nicknames found in column C.");

        drawWheel("nicknameWheel", nicknames);
        document.getElementById("loading").textContent = `–ó–Ω–∞–π–¥–µ–Ω–æ ${nicknames.length} —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –Ω—ñ–∫—ñ–≤.`;
        document.getElementById("spinBtn").disabled = false;
      } catch (err) {
        console.error(err);
        document.getElementById("loading").textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ API key / Sheet ID.";
      }
    }

    window.addEventListener("load", loadNicknames);
  </script>
</body>
</html>
